"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const { DynamoDBClient } = require('@aws-sdk/client-dynamodb');
const { DynamoDBDocumentClient, QueryCommand, PutCommand, DeleteCommand, ScanCommand, BatchWriteCommand } = require('@aws-sdk/lib-dynamodb');
const client = new DynamoDBClient({});
const dynamodb = DynamoDBDocumentClient.from(client);
const TABLE_NAME = process.env.DYNAMODB_TABLE_NAME;
const corsHeaders = {
    'Content-Type': 'application/json',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
};
const createResponse = (statusCode, body) => ({
    statusCode,
    headers: corsHeaders,
    body: JSON.stringify(body)
});
exports.handler = async (event) => {
    console.log('Event:', JSON.stringify(event, null, 2));
    if (event.httpMethod === 'OPTIONS') {
        return createResponse(200, {});
    }
    try {
        const { httpMethod, pathParameters, body } = event;
        const templateName = pathParameters?.templateName;
        switch (httpMethod) {
            case 'GET':
                return await getBudgetTemplates();
            case 'POST':
                if (pathParameters?.action === 'copy') {
                    return await copyBudgetTemplate(templateName, JSON.parse(body || '{}'));
                }
                return await createBudgetTemplate(JSON.parse(body || '{}'));
            case 'DELETE':
                return await deleteBudgetTemplate(templateName);
            default:
                return createResponse(405, { error: 'Method not allowed' });
        }
    }
    catch (error) {
        console.error('Error:', error);
        return createResponse(500, { error: 'Internal server error', details: error.message });
    }
};
async function getBudgetTemplates() {
    const params = {
        TableName: TABLE_NAME,
        FilterExpression: 'begins_with(PK, :pk)',
        ExpressionAttributeValues: {
            ':pk': 'TEMPLATE#'
        }
    };
    const result = await dynamodb.send(new ScanCommand(params));
    // Group by template name and calculate summary stats
    const templatesMap = new Map();
    result.Items.forEach((item) => {
        const templateName = item.template_name;
        if (!templatesMap.has(templateName)) {
            templatesMap.set(templateName, {
                template_name: templateName,
                category_count: 0,
                total_budget: 0,
                last_updated: item.created_at
            });
        }
        const template = templatesMap.get(templateName);
        template.category_count += 1;
        template.total_budget += item.budget_amount || 0;
        // Update last_updated if this item is newer
        if (item.created_at > template.last_updated) {
            template.last_updated = item.created_at;
        }
    });
    return createResponse(200, Array.from(templatesMap.values()));
}
async function createBudgetTemplate(data) {
    const { template_name, categories } = data;
    if (!template_name || !categories || !Array.isArray(categories)) {
        return createResponse(400, { error: 'Missing template_name or categories array' });
    }
    const timestamp = new Date().toISOString();
    const writeRequests = [];
    for (const category of categories) {
        const { category: categoryName, budget_amount, rollover_enabled = false } = category;
        if (!categoryName || budget_amount === undefined) {
            return createResponse(400, { error: 'Each category must have category name and budget_amount' });
        }
        const item = {
            PK: `TEMPLATE#${template_name}`,
            SK: `CATEGORY#${categoryName}`,
            GSI1PK: `TEMPLATE_ALL`,
            GSI1SK: `${template_name}#${categoryName}`,
            template_name,
            category: categoryName,
            budget_amount: parseFloat(budget_amount),
            rollover_enabled,
            is_active: true,
            created_at: timestamp
        };
        writeRequests.push({
            PutRequest: { Item: item }
        });
    }
    // Batch write all categories
    if (writeRequests.length > 0) {
        const chunks = [];
        for (let i = 0; i < writeRequests.length; i += 25) {
            chunks.push(writeRequests.slice(i, i + 25));
        }
        for (const chunk of chunks) {
            await dynamodb.send(new BatchWriteCommand({
                RequestItems: {
                    [`${TABLE_NAME}`]: chunk
                }
            }));
        }
    }
    return createResponse(201, {
        template_name,
        categories_created: categories.length,
        message: 'Budget template created successfully'
    });
}
async function copyBudgetTemplate(sourceTemplateName, data) {
    const { new_template_name } = data;
    if (!sourceTemplateName || !new_template_name) {
        return createResponse(400, { error: 'Missing source template name or new template name' });
    }
    // Get source template categories
    const queryParams = {
        TableName: TABLE_NAME,
        KeyConditionExpression: 'PK = :pk',
        ExpressionAttributeValues: {
            ':pk': `TEMPLATE#${sourceTemplateName}`
        }
    };
    const sourceResult = await dynamodb.send(new QueryCommand(queryParams));
    if (!sourceResult.Items || sourceResult.Items.length === 0) {
        return createResponse(404, { error: 'Source template not found' });
    }
    const timestamp = new Date().toISOString();
    const writeRequests = [];
    for (const sourceItem of sourceResult.Items) {
        const newItem = {
            PK: `TEMPLATE#${new_template_name}`,
            SK: sourceItem.SK,
            GSI1PK: `TEMPLATE_ALL`,
            GSI1SK: `${new_template_name}#${sourceItem.category}`,
            template_name: new_template_name,
            category: sourceItem.category,
            budget_amount: sourceItem.budget_amount,
            rollover_enabled: sourceItem.rollover_enabled,
            is_active: true,
            created_at: timestamp
        };
        writeRequests.push({
            PutRequest: { Item: newItem }
        });
    }
    // Batch write new template
    const chunks = [];
    for (let i = 0; i < writeRequests.length; i += 25) {
        chunks.push(writeRequests.slice(i, i + 25));
    }
    for (const chunk of chunks) {
        await dynamodb.send(new BatchWriteCommand({
            RequestItems: {
                [`${TABLE_NAME}`]: chunk
            }
        }));
    }
    return createResponse(201, {
        source_template: sourceTemplateName,
        new_template: new_template_name,
        categories_copied: sourceResult.Items.length,
        message: 'Budget template copied successfully'
    });
}
async function deleteBudgetTemplate(templateName) {
    if (!templateName) {
        return createResponse(400, { error: 'Missing template name' });
    }
    // Get all categories for this template
    const queryParams = {
        TableName: TABLE_NAME,
        KeyConditionExpression: 'PK = :pk',
        ExpressionAttributeValues: {
            ':pk': `TEMPLATE#${templateName}`
        }
    };
    const result = await dynamodb.send(new QueryCommand(queryParams));
    if (!result.Items || result.Items.length === 0) {
        return createResponse(404, { error: 'Template not found' });
    }
    const deleteRequests = [];
    for (const item of result.Items) {
        deleteRequests.push({
            DeleteRequest: {
                Key: {
                    PK: item.PK,
                    SK: item.SK
                }
            }
        });
    }
    // Batch delete all categories
    const chunks = [];
    for (let i = 0; i < deleteRequests.length; i += 25) {
        chunks.push(deleteRequests.slice(i, i + 25));
    }
    for (const chunk of chunks) {
        await dynamodb.send(new BatchWriteCommand({
            RequestItems: {
                [`${TABLE_NAME}`]: chunk
            }
        }));
    }
    return createResponse(200, {
        template_name: templateName,
        categories_deleted: result.Items.length,
        message: 'Budget template deleted successfully'
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVkZ2V0LXRlbXBsYXRlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJ1ZGdldC10ZW1wbGF0ZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNLEVBQUUsY0FBYyxFQUFFLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDL0QsTUFBTSxFQUNKLHNCQUFzQixFQUN0QixZQUFZLEVBQ1osVUFBVSxFQUNWLGFBQWEsRUFDYixXQUFXLEVBQ1gsaUJBQWlCLEVBQ2xCLEdBQUcsT0FBTyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFFckMsTUFBTSxNQUFNLEdBQUcsSUFBSSxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDdEMsTUFBTSxRQUFRLEdBQUcsc0JBQXNCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3JELE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUM7QUFFbkQsTUFBTSxXQUFXLEdBQUc7SUFDbEIsY0FBYyxFQUFFLGtCQUFrQjtJQUNsQyw2QkFBNkIsRUFBRSxHQUFHO0lBQ2xDLDhCQUE4QixFQUFFLGlDQUFpQztJQUNqRSw4QkFBOEIsRUFBRSxjQUFjO0NBQy9DLENBQUM7QUFFRixNQUFNLGNBQWMsR0FBRyxDQUFDLFVBQWtCLEVBQUUsSUFBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3pELFVBQVU7SUFDVixPQUFPLEVBQUUsV0FBVztJQUNwQixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7Q0FDM0IsQ0FBQyxDQUFDO0FBRUgsT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBVSxFQUFFLEVBQUU7SUFDckMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFdEQsSUFBSSxLQUFLLENBQUMsVUFB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QUU7UUFDekIsYUFBYSxFQUFFLFlBQVk7UUFDM0Isa0JBQWtCLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNO1FBQ3ZDLE9BQU8sRUFBRSxzQ0FBc0M7S0FDaEQsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgRHluYW1vREJDbGllbnQgfSA9IHJlcXVpcmUoJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYicpO1xuY29uc3QgeyBcbiAgRHluYW1vREJEb2N1bWVudENsaWVudCwgXG4gIFF1ZXJ5Q29tbWFuZCwgXG4gIFB1dENvbW1hbmQsIFxuICBEZWxldGVDb21tYW5kLFxuICBTY2FuQ29tbWFuZCxcbiAgQmF0Y2hXcml0ZUNvbW1hbmRcbn0gPSByZXF1aXJlKCdAYXdzLXNkay9saWItZHluYW1vZGInKTtcblxuY29uc3QgY2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGR5bmFtb2RiID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGNsaWVudCk7XG5jb25zdCBUQUJMRV9OQU1FID0gcHJvY2Vzcy5lbnYuRFlOQU1PREJfVEFCTEVfTkFNRTtcblxuY29uc3QgY29yc0hlYWRlcnMgPSB7XG4gICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCwgUE9TVCwgUFVULCBERUxFVEUsIE9QVElPTlMnLFxuICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUnXG59O1xuXG5jb25zdCBjcmVhdGVSZXNwb25zZSA9IChzdGF0dXNDb2RlOiBudW1iZXIsIGJvZHk6IGFueSkgPT4gKHtcbiAgc3RhdHVzQ29kZSxcbiAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gIGJvZHk6IEpTT04uc3RyaW5naWZ5KGJvZHkpXG59KTtcblxuZXhwb3J0cy5oYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnkpID0+IHtcbiAgY29uc29sZS5sb2coJ0V2ZW50OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50LCBudWxsLCAyKSk7XG4gIFxuICBpZiAoZXZlbnQuaHR0cE1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDIwMCwge30pO1xuICB9XG4gIFxuICB0cnkge1xuICAgIGNvbnN0IHsgaHR0cE1ldGhvZCwgcGF0aFBhcmFtZXRlcnMsIGJvZHkgfSA9IGV2ZW50O1xuICAgIGNvbnN0IHRlbXBsYXRlTmFtZSA9IHBhdGhQYXJhbWV0ZXJzPy50ZW1wbGF0ZU5hbWU7XG4gICAgXG4gICAgc3dpdGNoIChodHRwTWV0aG9kKSB7XG4gICAgICBjYXNlICdHRVQnOlxuICAgICAgICByZXR1cm4gYXdhaXQgZ2V0QnVkZ2V0VGVtcGxhdGVzKCk7XG4gICAgICBcbiAgICAgIGNhc2UgJ1BPU1QnOlxuICAgICAgICBpZiAocGF0aFBhcmFtZXRlcnM/LmFjdGlvbiA9PT0gJ2NvcHknKSB7XG4gICAgICAgICAgcmV0dXJuIGF3YWl0IGNvcHlCdWRnZXRUZW1wbGF0ZSh0ZW1wbGF0ZU5hbWUsIEpTT04ucGFyc2UoYm9keSB8fCAne30nKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGF3YWl0IGNyZWF0ZUJ1ZGdldFRlbXBsYXRlKEpTT04ucGFyc2UoYm9keSB8fCAne30nKSk7XG4gICAgICBcbiAgICAgIGNhc2UgJ0RFTEVURSc6XG4gICAgICAgIHJldHVybiBhd2FpdCBkZWxldGVCdWRnZXRUZW1wbGF0ZSh0ZW1wbGF0ZU5hbWUpO1xuICAgICAgXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gY3JlYXRlUmVzcG9uc2UoNDA1LCB7IGVycm9yOiAnTWV0aG9kIG5vdCBhbGxvd2VkJyB9KTtcbiAgICB9XG4gICAgXG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDUwMCwgeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsIGRldGFpbHM6IGVycm9yLm1lc3NhZ2UgfSk7XG4gIH1cbn07XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEJ1ZGdldFRlbXBsYXRlcygpIHtcbiAgY29uc3QgcGFyYW1zID0ge1xuICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcbiAgICBGaWx0ZXJFeHByZXNzaW9uOiAnYmVnaW5zX3dpdGgoUEssIDpwayknLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICc6cGsnOiAnVEVNUExBVEUjJ1xuICAgIH1cbiAgfTtcbiAgXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGR5bmFtb2RiLnNlbmQobmV3IFNjYW5Db21tYW5kKHBhcmFtcykpO1xuICBcbiAgLy8gR3JvdXAgYnkgdGVtcGxhdGUgbmFtZSBhbmQgY2FsY3VsYXRlIHN1bW1hcnkgc3RhdHNcbiAgY29uc3QgdGVtcGxhdGVzTWFwID0gbmV3IE1hcCgpO1xuICBcbiAgcmVzdWx0Lkl0ZW1zLmZvckVhY2goKGl0ZW06IGFueSkgPT4ge1xuICAgIGNvbnN0IHRlbXBsYXRlTmFtZSA9IGl0ZW0udGVtcGxhdGVfbmFtZTtcbiAgICBpZiAoIXRlbXBsYXRlc01hcC5oYXModGVtcGxhdGVOYW1lKSkge1xuICAgICAgdGVtcGxhdGVzTWFwLnNldCh0ZW1wbGF0ZU5hbWUsIHtcbiAgICAgICAgdGVtcGxhdGVfbmFtZTogdGVtcGxhdGVOYW1lLFxuICAgICAgICBjYXRlZ29yeV9jb3VudDogMCxcbiAgICAgICAgdG90YWxfYnVkZ2V0OiAwLFxuICAgICAgICBsYXN0X3VwZGF0ZWQ6IGl0ZW0uY3JlYXRlZF9hdFxuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IHRlbXBsYXRlID0gdGVtcGxhdGVzTWFwLmdldCh0ZW1wbGF0ZU5hbWUpO1xuICAgIHRlbXBsYXRlLmNhdGVnb3J5X2NvdW50ICs9IDE7XG4gICAgdGVtcGxhdGUudG90YWxfYnVkZ2V0ICs9IGl0ZW0uYnVkZ2V0X2Ftb3VudCB8fCAwO1xuICAgIFxuICAgIC8vIFVwZGF0ZSBsYXN0X3VwZGF0ZWQgaWYgdGhpcyBpdGVtIGlzIG5ld2VyXG4gICAgaWYgKGl0ZW0uY3JlYXRlZF9hdCA+IHRlbXBsYXRlLmxhc3RfdXBkYXRlZCkge1xuICAgICAgdGVtcGxhdGUubGFzdF91cGRhdGVkID0gaXRlbS5jcmVhdGVkX2F0O1xuICAgIH1cbiAgfSk7XG4gIFxuICByZXR1cm4gY3JlYXRlUmVzcG9uc2UoMjAwLCBBcnJheS5mcm9tKHRlbXBsYXRlc01hcC52YWx1ZXMoKSkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVCdWRnZXRUZW1wbGF0ZShkYXRhOiBhbnkpIHtcbiAgY29uc3QgeyB0ZW1wbGF0ZV9uYW1lLCBjYXRlZ29yaWVzIH0gPSBkYXRhO1xuICBcbiAgaWYgKCF0ZW1wbGF0ZV9uYW1lIHx8ICFjYXRlZ29yaWVzIHx8ICFBcnJheS5pc0FycmF5KGNhdGVnb3JpZXMpKSB7XG4gICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDQwMCwgeyBlcnJvcjogJ01pc3NpbmcgdGVtcGxhdGVfbmFtZSBvciBjYXRlZ29yaWVzIGFycmF5JyB9KTtcbiAgfVxuICBcbiAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICBjb25zdCB3cml0ZVJlcXVlc3RzID0gW107XG4gIFxuICBmb3IgKGNvbnN0IGNhdGVnb3J5IG9mIGNhdGVnb3JpZXMpIHtcbiAgICBjb25zdCB7IGNhdGVnb3J5OiBjYXRlZ29yeU5hbWUsIGJ1ZGdldF9hbW91bnQsIHJvbGxvdmVyX2VuYWJsZWQgPSBmYWxzZSB9ID0gY2F0ZWdvcnk7XG4gICAgXG4gICAgaWYgKCFjYXRlZ29yeU5hbWUgfHwgYnVkZ2V0X2Ftb3VudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gY3JlYXRlUmVzcG9uc2UoNDAwLCB7IGVycm9yOiAnRWFjaCBjYXRlZ29yeSBtdXN0IGhhdmUgY2F0ZWdvcnkgbmFtZSBhbmQgYnVkZ2V0X2Ftb3VudCcgfSk7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IGl0ZW0gPSB7XG4gICAgICBQSzogYFRFTVBMQVRFIyR7dGVtcGxhdGVfbmFtZX1gLFxuICAgICAgU0s6IGBDQVRFR09SWSMke2NhdGVnb3J5TmFtZX1gLFxuICAgICAgR1NJMVBLOiBgVEVNUExBVEVfQUxMYCxcbiAgICAgIEdTSTFTSzogYCR7dGVtcGxhdGVfbmFtZX0jJHtjYXRlZ29yeU5hbWV9YCxcbiAgICAgIHRlbXBsYXRlX25hbWUsXG4gICAgICBjYXRlZ29yeTogY2F0ZWdvcnlOYW1lLFxuICAgICAgYnVkZ2V0X2Ftb3VudDogcGFyc2VGbG9hdChidWRnZXRfYW1vdW50KSxcbiAgICAgIHJvbGxvdmVyX2VuYWJsZWQsXG4gICAgICBpc19hY3RpdmU6IHRydWUsXG4gICAgICBjcmVhdGVkX2F0OiB0aW1lc3RhbXBcbiAgICB9O1xuICAgIFxuICAgIHdyaXRlUmVxdWVzdHMucHVzaCh7XG4gICAgICBQdXRSZXF1ZXN0OiB7IEl0ZW06IGl0ZW0gfVxuICAgIH0pO1xuICB9XG4gIFxuICAvLyBCYXRjaCB3cml0ZSBhbGwgY2F0ZWdvcmllc1xuICBpZiAod3JpdGVSZXF1ZXN0cy5sZW5ndGggPiAwKSB7XG4gICAgY29uc3QgY2h1bmtzID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3cml0ZVJlcXVlc3RzLmxlbmd0aDsgaSArPSAyNSkge1xuICAgICAgY2h1bmtzLnB1c2god3JpdGVSZXF1ZXN0cy5zbGljZShpLCBpICsgMjUpKTtcbiAgICB9XG4gICAgXG4gICAgZm9yIChjb25zdCBjaHVuayBvZiBjaHVua3MpIHtcbiAgICAgIGF3YWl0IGR5bmFtb2RiLnNlbmQobmV3IEJhdGNoV3JpdGVDb21tYW5kKHtcbiAgICAgICAgUmVxdWVzdEl0ZW1zOiB7XG4gICAgICAgICAgW1RBQkxFX05BTUVdOiBjaHVua1xuICAgICAgICB9XG4gICAgICB9KSk7XG4gICAgfVxuICB9XG4gIFxuICByZXR1cm4gY3JlYXRlUmVzcG9uc2UoMjAxLCB7IFxuICAgIHRlbXBsYXRlX25hbWUsXG4gICAgY2F0ZWdvcmllc19jcmVhdGVkOiBjYXRlZ29yaWVzLmxlbmd0aCxcbiAgICBtZXNzYWdlOiAnQnVkZ2V0IHRlbXBsYXRlIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5J1xuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY29weUJ1ZGdldFRlbXBsYXRlKHNvdXJjZVRlbXBsYXRlTmFtZTogc3RyaW5nLCBkYXRhOiBhbnkpIHtcbiAgY29uc3QgeyBuZXdfdGVtcGxhdGVfbmFtZSB9ID0gZGF0YTtcbiAgXG4gIGlmICghc291cmNlVGVtcGxhdGVOYW1lIHx8ICFuZXdfdGVtcGxhdGVfbmFtZSkge1xuICAgIHJldHVybiBjcmVhdGVSZXNwb25zZSg0MDAsIHsgZXJyb3I6ICdNaXNzaW5nIHNvdXJjZSB0ZW1wbGF0ZSBuYW1lIG9yIG5ldyB0ZW1wbGF0ZSBuYW1lJyB9KTtcbiAgfVxuICBcbiAgLy8gR2V0IHNvdXJjZSB0ZW1wbGF0ZSBjYXRlZ29yaWVzXG4gIGNvbnN0IHF1ZXJ5UGFyYW1zID0ge1xuICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcbiAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnUEsgPSA6cGsnLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICc6cGsnOiBgVEVNUExBVEUjJHtzb3VyY2VUZW1wbGF0ZU5hbWV9YFxuICAgIH1cbiAgfTtcbiAgXG4gIGNvbnN0IHNvdXJjZVJlc3VsdCA9IGF3YWl0IGR5bmFtb2RiLnNlbmQobmV3IFF1ZXJ5Q29tbWFuZChxdWVyeVBhcmFtcykpO1xuICBcbiAgaWYgKCFzb3VyY2VSZXN1bHQuSXRlbXMgfHwgc291cmNlUmVzdWx0Lkl0ZW1zLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBjcmVhdGVSZXNwb25zZSg0MDQsIHsgZXJyb3I6ICdTb3VyY2UgdGVtcGxhdGUgbm90IGZvdW5kJyB9KTtcbiAgfVxuICBcbiAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICBjb25zdCB3cml0ZVJlcXVlc3RzID0gW107XG4gIFxuICBmb3IgKGNvbnN0IHNvdXJjZUl0ZW0gb2Ygc291cmNlUmVzdWx0Lkl0ZW1zKSB7XG4gICAgY29uc3QgbmV3SXRlbSA9IHtcbiAgICAgIFBLOiBgVEVNUExBVEUjJHtuZXdfdGVtcGxhdGVfbmFtZX1gLFxuICAgICAgU0s6IHNvdXJjZUl0ZW0uU0ssXG4gICAgICBHU0kxUEs6IGBURU1QTEFURV9BTExgLFxuICAgICAgR1NJMVNLOiBgJHtuZXdfdGVtcGxhdGVfbmFtZX0jJHtzb3VyY2VJdGVtLmNhdGVnb3J5fWAsXG4gICAgICB0ZW1wbGF0ZV9uYW1lOiBuZXdfdGVtcGxhdGVfbmFtZSxcbiAgICAgIGNhdGVnb3J5OiBzb3VyY2VJdGVtLmNhdGVnb3J5LFxuICAgICAgYnVkZ2V0X2Ftb3VudDogc291cmNlSXRlbS5idWRnZXRfYW1vdW50LFxuICAgICAgcm9sbG92ZXJfZW5hYmxlZDogc291cmNlSXRlbS5yb2xsb3Zlcl9lbmFibGVkLFxuICAgICAgaXNfYWN0aXZlOiB0cnVlLFxuICAgICAgY3JlYXRlZF9hdDogdGltZXN0YW1wXG4gICAgfTtcbiAgICBcbiAgICB3cml0ZVJlcXVlc3RzLnB1c2goe1xuICAgICAgUHV0UmVxdWVzdDogeyBJdGVtOiBuZXdJdGVtIH1cbiAgICB9KTtcbiAgfVxuICBcbiAgLy8gQmF0Y2ggd3JpdGUgbmV3IHRlbXBsYXRlXG4gIGNvbnN0IGNodW5rcyA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHdyaXRlUmVxdWVzdHMubGVuZ3RoOyBpICs9IDI1KSB7XG4gICAgY2h1bmtzLnB1c2god3JpdGVSZXF1ZXN0cy5zbGljZShpLCBpICsgMjUpKTtcbiAgfVxuICBcbiAgZm9yIChjb25zdCBjaHVuayBvZiBjaHVua3MpIHtcbiAgICBhd2FpdCBkeW5hbW9kYi5zZW5kKG5ldyBCYXRjaFdyaXRlQ29tbWFuZCh7XG4gICAgICBSZXF1ZXN0SXRlbXM6IHtcbiAgICAgICAgW1RBQkxFX05BTUVdOiBjaHVua1xuICAgICAgfVxuICAgIH0pKTtcbiAgfVxuICBcbiAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDIwMSwgeyBcbiAgICBzb3VyY2VfdGVtcGxhdGU6IHNvdXJjZVRlbXBsYXRlTmFtZSxcbiAgICBuZXdfdGVtcGxhdGU6IG5ld190ZW1wbGF0ZV9uYW1lLFxuICAgIGNhdGVnb3JpZXNfY29waWVkOiBzb3VyY2VSZXN1bHQuSXRlbXMubGVuZ3RoLFxuICAgIG1lc3NhZ2U6ICdCdWRnZXQgdGVtcGxhdGUgY29waWVkIHN1Y2Nlc3NmdWxseSdcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUJ1ZGdldFRlbXBsYXRlKHRlbXBsYXRlTmFtZTogc3RyaW5nKSB7XG4gIGlmICghdGVtcGxhdGVOYW1lKSB7XG4gICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDQwMCwgeyBlcnJvcjogJ01pc3NpbmcgdGVtcGxhdGUgbmFtZScgfSk7XG4gIH1cbiAgXG4gIC8vIEdldCBhbGwgY2F0ZWdvcmllcyBmb3IgdGhpcyB0ZW1wbGF0ZVxuICBjb25zdCBxdWVyeVBhcmFtcyA9IHtcbiAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ1BLID0gOnBrJyxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOnBrJzogYFRFTVBMQVRFIyR7dGVtcGxhdGVOYW1lfWBcbiAgICB9XG4gIH07XG4gIFxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBkeW5hbW9kYi5zZW5kKG5ldyBRdWVyeUNvbW1hbmQocXVlcnlQYXJhbXMpKTtcbiAgXG4gIGlmICghcmVzdWx0Lkl0ZW1zIHx8IHJlc3VsdC5JdGVtcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gY3JlYXRlUmVzcG9uc2UoNDA0LCB7IGVycm9yOiAnVGVtcGxhdGUgbm90IGZvdW5kJyB9KTtcbiAgfVxuICBcbiAgY29uc3QgZGVsZXRlUmVxdWVzdHMgPSBbXTtcbiAgXG4gIGZvciAoY29uc3QgaXRlbSBvZiByZXN1bHQuSXRlbXMpIHtcbiAgICBkZWxldGVSZXF1ZXN0cy5wdXNoKHtcbiAgICAgIERlbGV0ZVJlcXVlc3Q6IHtcbiAgICAgICAgS2V5OiB7XG4gICAgICAgICAgUEs6IGl0ZW0uUEssXG4gICAgICAgICAgU0s6IGl0ZW0uU0tcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIFxuICAvLyBCYXRjaCBkZWxldGUgYWxsIGNhdGVnb3JpZXNcbiAgY29uc3QgY2h1bmtzID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZGVsZXRlUmVxdWVzdHMubGVuZ3RoOyBpICs9IDI1KSB7XG4gICAgY2h1bmtzLnB1c2goZGVsZXRlUmVxdWVzdHMuc2xpY2UoaSwgaSArIDI1KSk7XG4gIH1cbiAgXG4gIGZvciAoY29uc3QgY2h1bmsgb2YgY2h1bmtzKSB7XG4gICAgYXdhaXQgZHluYW1vZGIuc2VuZChuZXcgQmF0Y2hXcml0ZUNvbW1hbmQoe1xuICAgICAgUmVxdWVzdEl0ZW1zOiB7XG4gICAgICAgIFtUQUJMRV9OQU1FXTogY2h1bmtcbiAgICAgIH1cbiAgICB9KSk7XG4gIH1cbiAgXG4gIHJldHVybiBjcmVhdGVSZXNwb25zZSgyMDAsIHsgXG4gICAgdGVtcGxhdGVfbmFtZTogdGVtcGxhdGVOYW1lLFxuICAgIGNhdGVnb3JpZXNfZGVsZXRlZDogcmVzdWx0Lkl0ZW1zLmxlbmd0aCxcbiAgICBtZXNzYWdlOiAnQnVkZ2V0IHRlbXBsYXRlIGRlbGV0ZWQgc3VjY2Vzc2Z1bGx5J1xuICB9KTtcbn0iXX0=